---
id: messaging
title: "ðŸŽ¯ Messaging"
---

import SuggestionFeature from "@site/src/components/Partials/SuggestionFeature";

## Introduction

<SuggestionFeature />

Le systÃ¨me de messaging de Bow Framework est un outil puissant qui permet d'envoyer des notifications via diffÃ©rents canaux (email, base de donnÃ©es, SMS). Il est conÃ§u pour Ãªtre flexible, extensible et facile Ã  utiliser. Que vous ayez besoin d'envoyer des emails de bienvenue, des notifications d'activitÃ© ou des alertes systÃ¨me, le systÃ¨me de messaging vous couvre.

## Configuration

### PrÃ©paration du ModÃ¨le

Pour commencer, votre modÃ¨le doit implÃ©menter le trait `CanSendMessage`. Ce trait ajoute toutes les mÃ©thodes nÃ©cessaires pour envoyer des notifications.

```php
use Bow\Messaging\CanSendMessage;
use Bow\Database\Barry\Model;

class User extends Model 
{
    use CanSendMessage;
    
    // Votre modÃ¨le peut avoir d'autres propriÃ©tÃ©s et mÃ©thodes
    protected $fillable = ['name', 'email'];
}
```

## CrÃ©ation de Notifications

### Structure de Base

Une notification est une classe qui Ã©tend `Messaging`. Voici un exemple complet d'une notification de bienvenue :

```php
use Bow\Messaging\Messaging;
use Bow\Mail\Message;
use Bow\Database\Barry\Model;

class WelcomeMessage extends Messaging
{
    /**
     * Constructeur pour passer des donnÃ©es Ã  la notification
     */
    public function __construct(
        private string $customMessage = "Bienvenue!"
    ) {
    }

    /**
     * Configuration du message email
     */
    public function toMail(Model $notifiable): Message
    {
        return (new Message())
            ->to($notifiable->email)
            ->subject('Bienvenue sur notre plateforme!')
            ->view('emails.welcome', [
                'user' => $notifiable,
                'message' => $this->customMessage
            ]);
    }

    /**
     * Configuration de la notification en base de donnÃ©es
     */
    public function toDatabase(Model $notifiable): array
    {
        return [
            'type' => 'welcome_notification',
            'data' => [
                'user_id' => $notifiable->id,
                'message' => $this->customMessage,
                'created_at' => now()
            ]
        ];
    }

    /**
     * DÃ©finition des canaux Ã  utiliser
     */
    public function channels(Model $notifiable): array
    {
        // Vous pouvez ajouter une logique conditionnelle
        if ($notifiable->preferences['email_notifications']) {
            return ['mail', 'database'];
        }
        
        return ['database'];
    }
}
```

### Exemples de Notifications Courantes

#### Notification de RÃ©initialisation de Mot de Passe

```php
class PasswordResetMessage extends Messaging
{
    public function __construct(
        private string $token
    ) {
    }

    public function toMail(Model $notifiable): Message
    {
        $resetUrl = url("/password/reset/{$this->token}");

        return (new Message())
            ->to($notifiable->email)
            ->subject('RÃ©initialisation de votre mot de passe')
            ->view('emails.password-reset', [
                'user' => $notifiable,
                'resetUrl' => $resetUrl,
                'expiresIn' => '60 minutes'
            ]);
    }

    public function channels(Model $notifiable): array
    {
        return ['mail'];
    }
}
```

#### Notification d'ActivitÃ©

```php
class NewCommentMessage extends Messaging
{
    public function __construct(
        private array $commentData
    ) {
    }

    public function toMail(Model $notifiable): Message
    {
        return (new Message())
            ->to($notifiable->email)
            ->subject('Nouveau commentaire sur votre post')
            ->view('emails.new-comment', [
                'user' => $notifiable,
                'comment' => $this->commentData
            ]);
    }

    public function toDatabase(Model $notifiable): array
    {
        return [
            'type' => 'new_comment',
            'data' => [
                'post_id' => $this->commentData['post_id'],
                'comment_id' => $this->commentData['id'],
                'commenter' => $this->commentData['user_name'],
                'excerpt' => substr($this->commentData['content'], 0, 100)
            ]
        ];
    }

    public function channels(Model $notifiable): array
    {
        return ['mail', 'database'];
    }
}
```

## Envoi de Notifications

### Envoi Simple

L'envoi simple est synchrone et immÃ©diat :

```php
// Envoi d'une notification de bienvenue basique
$user->sendMessage(new WelcomeMessage());

// Envoi avec un message personnalisÃ©
$user->sendMessage(new WelcomeMessage("Ravi de vous avoir parmi nous!"));

// Envoi d'une notification de rÃ©initialisation de mot de passe
$user->sendMessage(new PasswordResetMessage($token));

// Envoi d'une notification de nouveau commentaire
$user->sendMessage(new NewCommentMessage([
    'id' => 1,
    'post_id' => 123,
    'user_name' => 'John Doe',
    'content' => 'Super article!'
]));
```

### Envoi en File d'Attente

L'envoi en file d'attente est asynchrone et permet de meilleures performances :

```php
// File d'attente par dÃ©faut
$user->setMessageQueue(new WelcomeMessage());

// File d'attente spÃ©cifique avec prioritÃ©
$user->sendMessageQueueOn('high-priority', new PasswordResetMessage($token));

// Envoi diffÃ©rÃ© (utile pour les rappels)
$user->sendMessageLater(
    3600, // dÃ©lai en secondes (1 heure)
    new ReminderMessage("N'oubliez pas de complÃ©ter votre profil!")
);

// Envoi diffÃ©rÃ© sur une file spÃ©cifique
$user->sendMessageLaterOn(
    1800, // 30 minutes
    'reminders',
    new ReminderMessage("Finalisez votre commande!")
);
```

## Canaux de Notification

### Email

Le canal email est parfait pour les communications importantes. Exemple complet d'une notification par email :

```php
public function toMail(Model $notifiable): Message
{
    return (new Message())
        ->to($notifiable->email)
        ->cc('support@example.com')
        ->bcc('archives@example.com')
        ->subject('Sujet Important')
        ->view('emails.template', [
            'user' => $notifiable,
            'data' => $this->data
        ])
        ->attach('/chemin/vers/fichier.pdf')
        ->priority('high');
}
```

### Base de DonnÃ©es

Le canal de base de donnÃ©es est idÃ©al pour les notifications in-app. Structure complÃ¨te :

```sql
CREATE TABLE notifications (
    id CHAR(36) PRIMARY KEY,
    concern_id BIGINT NOT NULL,
    concern_type VARCHAR(255) NOT NULL,
    type VARCHAR(255) NOT NULL,
    data JSON NOT NULL,
    read_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

Exemple d'utilisation avancÃ©e :

```php
public function toDatabase(Model $notifiable): array
{
    return [
        'type' => 'system_notification',
        'data' => [
            'title' => 'Mise Ã  jour SystÃ¨me',
            'message' => 'Une nouvelle version est disponible',
            'action_url' => '/settings/updates',
            'action_text' => 'Mettre Ã  jour maintenant',
            'severity' => 'high',
            'icon' => 'update-icon',
            'metadata' => [
                'version' => '2.0.0',
                'changes' => ['feature1', 'feature2']
            ]
        ]
    ];
}
```

### SMS

Pour implÃ©menter le canal SMS, crÃ©ez une classe dÃ©diÃ©e :

```php
class SmsChannel implements ChannelInterface
{
    public function __construct(
        private SmsService $smsService
    ) {
    }

    public function send(Model $notifiable): void
    {
        $this->smsService->send(
            $notifiable->phone_number,
            $this->formatMessage()
        );
    }
}
```

## Extension du SystÃ¨me

### CrÃ©ation d'un Nouveau Canal

Exemple de crÃ©ation d'un canal pour les notifications Slack :

```php
namespace App\Messaging\Channels;

use Bow\Messaging\Contracts\ChannelInterface;
use Bow\Database\Barry\Model;

class SlackChannel implements ChannelInterface
{
    public function __construct(
        private array $slackConfig
    ) {
    }

    public function send(Model $notifiable): void
    {
        $client = new SlackClient($this->slackConfig['webhook_url']);
        
        $client->send([
            'channel' => $this->slackConfig['channel'],
            'text' => $this->slackConfig['message'],
            'attachments' => $this->slackConfig['attachments'] ?? []
        ]);
    }
}
```

### Enregistrement du Nouveau Canal

```php
// Dans votre classe de notification
protected array $channels = [
    'slack' => SlackChannel::class
];

public function toSlack(Model $notifiable): array
{
    return [
        'webhook_url' => config('services.slack.webhook_url'),
        'channel' => '#notifications',
        'message' => 'Nouvelle notification!',
        'attachments' => [
            [
                'title' => 'DÃ©tails',
                'text' => 'Contenu de la notification'
            ]
        ]
    ];
}
```

## Bonnes Pratiques

1. **Segmentation** : CrÃ©ez des notifications spÃ©cifiques pour chaque cas d'utilisation
2. **Files d'attente** : Utilisez les files d'attente pour les notifications non urgentes
3. **Personnalisation** : Permettez aux utilisateurs de choisir leurs canaux prÃ©fÃ©rÃ©s
4. **Tests** : Testez vos notifications avec des cas rÃ©els
5. **Monitoring** : Surveillez les Ã©checs d'envoi et mettez en place des retry policies

## DÃ©bogage

Pour dÃ©boguer vos notifications, vous pouvez :

```php
// Journaliser les envois
Log::info('Envoi de notification', [
    'type' => get_class($notification),
    'user' => $notifiable->id,
    'channels' => $notification->channels($notifiable)
]);

// Tester en environnement local
config(['mail.default' => 'log']);
```
