---
id: messaging
title: "ðŸŽ¯ SystÃ¨me de messaging"
---

import SuggestionFeature from "@site/src/components/Partials/SuggestionFeature";

## Introduction

:::info Ã€ propos du systÃ¨me de messaging
Le systÃ¨me de messaging de Bow Framework est un outil puissant qui permet d'envoyer des notifications via diffÃ©rents canaux (email, base de donnÃ©es, SMS). Il est conÃ§u pour Ãªtre flexible, extensible et facile Ã  utiliser.
:::

Que vous ayez besoin d'envoyer des emails de bienvenue, des notifications d'activitÃ© ou des alertes systÃ¨me, le systÃ¨me de messaging vous couvre.

## Configuration

### PrÃ©paration du ModÃ¨le

Pour commencer, votre modÃ¨le doit implÃ©menter le trait `CanSendMessage`. Ce trait ajoute toutes les mÃ©thodes nÃ©cessaires pour envoyer des notifications.

```php
use Bow\Messaging\CanSendMessage;
use Bow\Database\Barry\Model;

class User extends Model 
{
  use CanSendMessage;
}
```

## CrÃ©ation de Notifications

### Structure de Base

Une notification est une classe qui Ã©tend `Messaging`. Voici un exemple complet d'une notification de bienvenue :

```php
use Bow\Messaging\Messaging;
use Bow\Mail\Envelop;
use Bow\Database\Barry\Model;

class WelcomeMessage extends Messaging
{
  /**
   * Constructeur - passe des donnÃ©es Ã  la notification
   */
  public function __construct(
    private string $customMessage = "Bienvenue!"
  ) {
  }

  /**
   * Configure le message email
   */
  public function toMail(Model $context): ?Envelop
  {
    return (new Envelop())
      ->to($context->email)
      ->subject('Bienvenue sur notre plateforme!')
      ->view('emails.welcome', [
        'user' => $context,
        'message' => $this->customMessage
      ]);
  }

  /**
   * Configure la notification en base de donnÃ©es
   */
  public function toDatabase(Model $context): array
  {
    return [
      'type' => 'welcome_notification',
      'data' => [
        'user_id' => $context->id,
        'message' => $this->customMessage,
        'created_at' => now()
      ]
    ];
  }

  /**
   * DÃ©finit les canaux Ã  utiliser
   */
  public function channels(Model $context): array
  {
    // Vous pouvez ajouter une logique conditionnelle
    if ($context->preferences['email_notifications']) {
      return ['mail', 'database'];
    }
    
    return ['database'];
  }
}
```

### Exemples de Notifications Courantes

#### Notification de RÃ©initialisation de Mot de Passe

```php
class PasswordResetMessage extends Messaging
{
  public function __construct(
    private string $token
  ) {
  }

  public function toMail(Model $context): Envelop
  {
    $resetUrl = url("/password/reset/{$this->token}");

    return (new Envelop())
      ->to($context->email)
      ->subject('RÃ©initialisation de votre mot de passe')
      ->view('emails.password-reset', [
        'user' => $context,
        'resetUrl' => $resetUrl,
        'expiresIn' => '60 minutes'
      ]);
  }

  public function channels(Model $context): array
  {
    return ['mail'];
  }
}
```

#### Notification d'ActivitÃ©

```php
class NewCommentMessage extends Messaging
{
  public function __construct(
    private array $commentData
  ) {
  }

  public function toMail(Model $context): Envelop
  {
    return (new Envelop())
      ->to($context->email)
      ->subject('Nouveau commentaire sur votre post')
      ->view('emails.new-comment', [
        'user' => $context,
        'comment' => $this->commentData
      ]);
  }

  public function toDatabase(Model $context): array
  {
    return [
      'type' => 'new_comment',
      'data' => [
        'post_id' => $this->commentData['post_id'],
        'comment_id' => $this->commentData['id'],
        'commenter' => $this->commentData['user_name'],
        'excerpt' => substr($this->commentData['content'], 0, 100)
      ]
    ];
  }

  public function channels(Model $context): array
  {
    return ['mail', 'database'];
  }
}
```

## Envoi de Notifications

### Envoi Simple

L'envoi simple est synchrone et immÃ©diat :

```php
// Envoi d'une notification de bienvenue basique
$user->sendMessage(new WelcomeMessage());

// Envoi avec un message personnalisÃ©
$user->sendMessage(new WelcomeMessage("Ravi de vous avoir parmi nous!"));

// Envoi d'une notification de rÃ©initialisation de mot de passe
$user->sendMessage(new PasswordResetMessage($token));

// Envoi d'une notification de nouveau commentaire
$user->sendMessage(new NewCommentMessage([
  'id' => 1,
  'post_id' => 123,
  'user_name' => 'John Doe',
  'content' => 'Super article!'
]));
```

### Envoi en File d'Attente

:::tip Performances optimales
L'envoi en file d'attente est asynchrone et permet de meilleures performances. Utilisez cette mÃ©thode pour les notifications non critiques.
:::

```php
// File d'attente par dÃ©faut
$user->setMessageQueue(new WelcomeMessage());

// File d'attente spÃ©cifique avec prioritÃ©
$user->sendMessageQueueOn('high-priority', new PasswordResetMessage($token));

// Envoi diffÃ©rÃ© (utile pour les rappels)
$user->sendMessageLater(
  3600, // dÃ©lai en secondes (1 heure)
  new ReminderMessage("N'oubliez pas de complÃ©ter votre profil!")
);

// Envoi diffÃ©rÃ© sur une file spÃ©cifique
$user->sendMessageLaterOn(
  1800, // 30 minutes
  'reminders',
  new ReminderMessage("Finalisez votre commande!")
);
```

## Canaux de Notification

### Email

Le canal email est parfait pour les communications importantes. Exemple complet d'une notification par email :

```php
public function toMail(Model $context): Envelop
{
  return (new Envelop())
    ->to($context->email)
    ->cc('support@example.com')
    ->bcc('archives@example.com')
    ->subject('Sujet Important')
    ->view('emails.template', [
      'user' => $context,
      'data' => $this->data
    ])
    ->attach('/chemin/vers/fichier.pdf')
    ->priority('high');
}
```

### Base de DonnÃ©es

Le canal de base de donnÃ©es est idÃ©al pour les notifications in-app.

:::info Structure de la table
Voici la structure complÃ¨te de la table `notifications` nÃ©cessaire pour le canal database :
:::

```sql
CREATE TABLE notifications (
  id CHAR(36) PRIMARY KEY,
  concern_id BIGINT NOT NULL,
  concern_type VARCHAR(255) NOT NULL,
  type VARCHAR(255) NOT NULL,
  data JSON NOT NULL,
  read_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

Exemple d'utilisation avancÃ©e :

```php
public function toDatabase(Model $context): array
{
  return [
    'type' => 'system_notification',
    'data' => [
      'title' => 'Mise Ã  jour SystÃ¨me',
      'message' => 'Une nouvelle version est disponible',
      'action_url' => '/settings/updates',
      'action_text' => 'Mettre Ã  jour maintenant',
      'severity' => 'high',
      'icon' => 'update-icon',
      'metadata' => [
        'version' => '2.0.0',
        'changes' => ['feature1', 'feature2']
      ]
    ]
  ];
}
```

## Extension du SystÃ¨me

:::tip ExtensibilitÃ©
Vous pouvez crÃ©er vos propres canaux personnalisÃ©s pour envoyer des notifications via d'autres moyens (SMS, Slack, Push, etc.).
:::

### CrÃ©ation d'un Nouveau Canal

Exemple de crÃ©ation d'un canal pour les notifications Log :

```php
namespace App\Messaging\Channels;

use Bow\Messaging\Contracts\ChannelInterface;
use Bow\Database\Barry\Model;

class LogChannel implements ChannelInterface
{
  public function send(Model $context, Messaging $message): void
  {
    if (!method_exists($message, 'toLog')) {
      throw new \InvalidArgumentException('The message must have a toLog method.');
    }

    $log = $message->toLog($context);

    logger()->log($log);
  }
}
```

### Enregistrement du Nouveau Canal

Pour enregistrer votre nouveau canal, vous devez l'ajouter dans la configuration de l'application. Dans votre fichier `App\Configurations\ApplicationConfiguration.php`, ajoutez le code suivant dans la mÃ©thode `create()` :

```php title="app/Configurations/ApplicationConfiguration.php"
public function create(Loader $config): void  
{
  Messaging::pushChannels([
    'log' => LogChannel::class
  ]);
}
```

## Bonnes Pratiques

:::warning Recommandations importantes
Suivez ces bonnes pratiques pour un systÃ¨me de messaging robuste et performant.
:::

1. **Segmentation** - CrÃ©ez des notifications spÃ©cifiques pour chaque cas d'utilisation
2. **Files d'attente** - Utilisez les files d'attente pour les notifications non urgentes
3. **Personnalisation** - Permettez aux utilisateurs de choisir leurs canaux prÃ©fÃ©rÃ©s
4. **Tests** - Testez vos notifications avec des cas rÃ©els
5. **Monitoring** - Surveillez les Ã©checs d'envoi et mettez en place des stratÃ©gies de nouvelle tentative

## DÃ©bogage

Pour dÃ©boguer vos notifications, vous pouvez :

```php
// Journaliser les envois
Log::info('Envoi de notification', [
  'type' => get_class($notification),
  'user' => $context->id,
  'channels' => $notification->channels($context)
]);

// Tester en environnement local
config(['mail.default' => 'log']);
```

<SuggestionFeature />
