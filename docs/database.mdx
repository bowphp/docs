---
id: database
title: "ðŸŽ¯ DÃ©marrage"
---

import SuggestionFeature from "@site/src/components/Partials/SuggestionFeature";

## Introduction

Bow rend l'interaction avec les bases de donnÃ©es extrÃªmement simple en utilisant le `SQL brut`, le gÃ©nÃ©rateur de requÃªtes fluide et l'[ORM](./orm) Barry.

Actuellement, Bow prend en charge trois bases de donnÃ©es:

- MySQL
- PostgreSQL
- SQLite

## Configuration

La configuration de la base de donnÃ©es de votre application se trouve dans le fichier `config/database.php`. Dans ce fichier, vous pouvez dÃ©finir toutes les connexions Ã  vos bases de donnÃ©es. Des exemples de configuration sont fournis pour tous les types de bases de donnÃ©es supportÃ©s.

## Configuration SQLite

AprÃ¨s avoir crÃ©Ã© une nouvelle base de donnÃ©es SQLite Ã  l'aide d'une commande telle que `touch var/database.sqlite`, vous pouvez facilement configurer vos variables d'environnement (dans le fichier `.env.json`) pour qu'elles pointent vers cette base de donnÃ©es en utilisant le chemin absolu:

```json
{
  "DB_DEFAULT": "sqlite",
  "SQLITE_DATABASE": "/absolute/path/to/database.sqlite"
}
```

## Connexions multiples

Lorsque vous utilisez plusieurs connexions, vous pouvez accÃ©der Ã  chaque connexion via la mÃ©thode statique `connection` de la classe [Bow\Database\Database::class](https://bowphp.com/api/master/Bow/Database/Database.html). Le nom passÃ© Ã  la mÃ©thode doit correspondre Ã  l'une des connexions dÃ©finies dans votre fichier de configuration `config/database.php`:

```php
use Bow\Database\Database;

$users = Database::connection('sqlite')->select(...);
```

Ou via le helper `db`:

```php
$users = db('sqlite')->select(...);
```

Une fois la configuration modifiÃ©e, elle est directement appliquÃ©e sur la connexion des modÃ¨les. [Consultez la documentation ORM](./orm) pour plus d'informations sur les modÃ¨les.

## Utilisation de requÃªtes SQL brutes

Les requÃªtes brutes sont des requÃªtes SQL Ã©crites directement sans passer par le Query Builder.
Dans cette section, nous allons utiliser une table nommÃ©e `pets` pour effectuer nos exemples.

Voici la structure de la table `pets`:

```sql
CREATE TABLE `pets` (
  id int primary key,
  name varchar(200),
  color varchar(50)
);
```

Description des colonnes de la table:

| Colonne | Description |
| ------- | ----------- |
| `id`    | ClÃ© primaire de la table |
| `name`  | Nom de l'animal |
| `color` | Couleur de l'animal |

> ðŸ’¡ Pour information, un `pet` est un animal domestique en anglais.

### ExÃ©cution de requÃªtes SELECT

Pour exÃ©cuter une requÃªte brute de type `SELECT`, vous devez utiliser la mÃ©thode `Database::select` ou le helper `app_db_select`. ConsidÃ©rons notre table `pets` et supposons que nous sommes bien connectÃ©s Ã  la base de donnÃ©es.

Exemple pour rÃ©cupÃ©rer toutes les informations de la table `pets`:

```php
use Bow\Database\Database;

$pets = Database::select('select * from `pets`');
```

Via helper `app_db_select`:

```php
$pets = app_db_select('select * from `pets`');
```

### SÃ©lection avec conditions

Voici comment rÃ©cupÃ©rer un enregistrement spÃ©cifique de la table `pets` en utilisant une condition WHERE:

```php
use Bow\Database\Database;

$pet = Database::select('select * from `pets` where id = :id', ['id' => 1]);
```

Via helper `app_db_select`:

```php
$pet = app_db_select('select * from `pets` where id = :id', ['id' => 1]);
```

:::info
La mÃ©thode `app_db_select` retourne un `array` d'objets `stdClass` ou un tableau vide s'il n'y a aucun rÃ©sultat. Chaque Ã©lÃ©ment du tableau est un objet contenant les colonnes de la table. Pour plus d'informations sur `stdClass`, consultez [la documentation PHP](http://php.net/manual/fr/language.types.object.php).
:::

### ExÃ©cution de requÃªtes INSERT

Pour exÃ©cuter une requÃªte brute de type `INSERT`, utilisez la mÃ©thode `Database::insert` ou le helper `app_db_insert`.

Exemple d'insertion d'un enregistrement dans la table `pets`:

```php
use Bow\Database\Database;

$pet = [
  'id' => 1,
  'name' => 'Medor',
  'color' => 'Green'
];

$inserted = Database::insert('insert into `pets` (id, name, color) values (:id, :name, :color);', $pet);
```

Via helper `app_db_insert`:

```php
$pet = [
  'id' => 2,
  'name' => 'Marshmallow',
  'color' => 'White'
];

$inserted = app_db_insert('insert into `pets` (id, name, color) values (:id, :name, :color);', $pet);
```

:::info
La mÃ©thode `app_db_insert` retourne un entier reprÃ©sentant le nombre de lignes insÃ©rÃ©es.
:::

#### Insertion multiple

Vous pouvez Ã©galement insÃ©rer plusieurs enregistrements simultanÃ©ment.

```php
use Bow\Database\Database;

// Liste de plusieurs animaux
$pets = [
  [
    'id' => 1,
    'name' => 'MÃ©dor',
    'color' => 'Black'
  ],
  [
    'id' => 2,
    'name' => 'Milou',
    'color' => 'White'
  ]
];

$inserted = Database::insert(
  'insert into `pets` (id, name, color) values (:id, :name, :color);',
  $pets
);
```

Via helper `app_db_insert`:

```php
$updated = app_db_insert(
  'insert into `pets` (id, name, color) values (:id, :name, :color);',
  $pets
);
```

### ExÃ©cution de requÃªtes UPDATE

Pour exÃ©cuter une requÃªte brute de type `UPDATE`, utilisez la mÃ©thode `Database::update` ou le helper `app_db_update`.

Exemple de mise Ã  jour d'un enregistrement dans la table `pets`:

```php
use Bow\Database\Database;

$pet = [
  'id' => 1,
  'name' => 'Medora',
  'color' => 'Purple'
];

$updated = Database::update(
  'update `pets` set id = :id, name = :name, color = :color where id = :id',
  $pet
);
```

Via le helper `app_db_update`:

```php
$pet = [
  'id' => 2,
  'name' => 'Spark',
  'color' => 'Yellow'
];

$updated = app_db_update(
  'update `pets` set id = :id, name = :name, color = :color where id = :id',
  $pet
);
```

### ExÃ©cution de requÃªtes DELETE

Pour exÃ©cuter une requÃªte brute de type `DELETE`, utilisez la mÃ©thode `Database::delete` ou le helper `app_db_delete`.

Exemple de suppression d'un enregistrement dans la table `pets`:

```php
use Bow\Database\Database;

$deleted = Database::delete(
  'delete from `pets` where id = :id',
  ['id' => 1]
);
```

Via le helper `app_db_delete`:

```php
$deleted = app_db_delete(
  'delete from `pets` where id = :id',
  ['id' => 2]
);
```

### ExÃ©cution de requÃªtes gÃ©nÃ©riques

Pour exÃ©cuter des requÃªtes autres que `SELECT`, `UPDATE`, `INSERT` ou `DELETE` (comme `ALTER TABLE`, `CREATE TABLE`, etc.), utilisez la mÃ©thode `Database::statement` ou le helper `app_db_statement`.

```php
use Bow\Database\Database;

Database::statement('alter table `pets` add `owner` varchar(80) default null;');
```

Via le helper `app_db_statement`:

```php
app_db_statement('alter table `pets` add `owner` varchar(80) default null;');
```

## Transactions de base de donnÃ©es

Utilisez la mÃ©thode `startTransaction` de la classe `Database` pour exÃ©cuter un ensemble d'opÃ©rations dans une transaction.

Lorsque vous passez une fonction de rappel (`Closure`), la transaction fonctionne automatiquement:
- Si une exception est levÃ©e, la transaction est automatiquement annulÃ©e (rollback)
- Si tout se passe bien, la transaction est automatiquement validÃ©e (commit)

Vous n'avez pas Ã  gÃ©rer manuellement l'annulation ou la validation:

```php
use Bow\Database\Database;

Database::startTransaction(function () {
  Database::update('update users set votes = :votes', ['votes' => 1]);

  Database::delete('delete from posts');
});
```

Via le helper `app_db_transaction`:

```php
app_db_transaction(function () {
  update('update users set votes = :votes', ['votes' => 1]);

  delete('delete from posts');
});
```

### Gestion manuelle des transactions

Vous pouvez Ã©galement gÃ©rer manuellement les transactions pour un contrÃ´le plus fin.

Pour dÃ©marrer une transaction:

```php
use Bow\Database\Database;

Database::startTransaction();
// Ou
app_db_transaction();
```

Vous pouvez annuler la transaction avec la mÃ©thode:

```php
use Bow\Database\Database;

Database::rollback();
// Ou
app_db_rollback();
```

Vous pouvez valider la transaction avec la mÃ©thode:

```php
use Bow\Database\Database;

Database::commit();
// Ou
app_db_commit();
```

Pour vÃ©rifier si une transaction est en cours, utilisez la mÃ©thode `inTransaction`:

```php
use Bow\Database\Database;

Database::inTransaction();
// Ou
app_db_transaction_started();
```

## Jointures SQL

Les jointures permettent de combiner des donnÃ©es de plusieurs tables. ConsidÃ©rons les tables suivantes:

```sql
create table `authors` (
  `id` int primary key,
  `name` varchar(200)
);

create table `pets` (
  `id` int primary key,
  `name` varchar(200),
  `color` varchar(50),
  `author_id` int default 0
);
```

Pour effectuer une jointure dans Bow Framework, utilisez simplement la mÃ©thode `join`:

```php
$results = app_db_table('pets')
  ->join('authors', 'authors.id', 'pets.author_id')
  ->get();
```

Vous pouvez ajouter des conditions avec la clause `WHERE` pour filtrer les rÃ©sultats:

```php
$results = app_db_table('pets')
  ->join('authors', 'authors.id', 'pets.author_id')
  ->whereRaw('pets.author_id', 1)->get();
```

Vous pouvez chaÃ®ner plusieurs jointures pour combiner plus de deux tables.
Par exemple, si nous avons une table `countries` contenant les pays des propriÃ©taires, et que la table `authors` devient:

```sql
create table `authors` (
  `id` int primary key,
  `name` varchar(200),
  `country_id` int
);
```

Notre requÃªte avec deux jointures sera:

```php
$results = app_db_table('pets')
  ->join('authors', 'authors.id', 'pets.author_id')
  ->join('countries', 'countries.id', 'authors.country_id')
  ->where('pets.author_id', 1)
  ->get();
```

:::note
Vous pouvez consulter l'API de la classe [Database](./api/5.x/Bow/Database/Database.html) pour plus d'information.
:::

<SuggestionFeature />
