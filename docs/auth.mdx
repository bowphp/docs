---
id: auth
title: "üëÆüèΩ Authentification"
---

import SuggestionFeature from "@site/src/components/Partials/SuggestionFeature";

## Introduction

L'authentification est un aspect essentiel de toute application web. BowPHP fournit un syst√®me d'authentification flexible et facile √† configurer, qui prend en charge deux m√©thodes principales : l'authentification par session et l'authentification par JWT (JSON Web Token). Cette documentation vous guidera √©tape par √©tape pour int√©grer et personnaliser le syst√®me d'authentification dans votre application.

## Table des mati√®res
- [1. Configuration de l'authentification](#configuration)
- [2. Mod√®le d'authentification](#modele-dauthentification)
- [3. Utilisation de base](#utilisation-de-base)
- [4. Authentification avec JWT](#authentification-jwt)
- [5. Middleware d'authentification](#middleware)

## 1. Configuration de l'authentification

BowPHP utilise un fichier de configuration pour g√©rer les diff√©rentes options d'authentification. Ce fichier se trouve dans `config/auth.php`. Vous y d√©finissez les types d'authentification que vous souhaitez utiliser, ainsi que les param√®tres associ√©s (comme les mod√®les utilisateurs et les cl√©s de connexion).

### Exemple de configuration

```php
return [
    // D√©finit le guard par d√©faut utilis√©
    'default' => 'web',

    // Configuration du guard web (session)
    'web' => [
        'type' => 'session', // Authentification par session
        'model' => \App\Models\User::class, // Mod√®le utilisateur
        'credentials' => [
            'username' => 'email', // Champ d'authentification
            'password' => 'password' // Mot de passe
        ]
    ],

    // Configuration du guard api (JWT)
    'api' => [
        'type' => 'jwt', // Authentification par JWT
        'model' => \App\Models\User::class,
        'credentials' => [
            'username' => 'email',
            'password' => 'password'
        ]
    ]
];
```

Dans cet exemple, vous avez deux types de "guards" : `web` pour les sessions classiques et `api` pour les API utilisant JWT.

## 2. Mod√®le d'authentification

Votre mod√®le utilisateur doit impl√©menter l'interface d'authentification de BowPHP. Cela se fait en √©tendant la classe `Bow\Auth\Authentication` dans votre mod√®le `User`.

### Exemple :

```php
use Bow\Auth\Authentication;

class User extends Authentication
{
    // Propri√©t√©s et m√©thodes de votre mod√®le
}
```

Cela permet √† BowPHP de g√©rer l'authentification de vos utilisateurs de mani√®re transparente.

## 3. Utilisation de base

Une fois votre configuration en place et votre mod√®le utilisateur configur√©, vous pouvez commencer √† utiliser le syst√®me d'authentification dans vos contr√¥leurs et routes.

### M√©thode `guard`

Le syst√®me d'authentification de BowPHP prend en charge plusieurs **guards**, qui sont des m√©canismes distincts permettant de g√©rer l'authentification. Vous pouvez configurer plusieurs guards dans votre fichier `config/auth.php` (par exemple, un pour l'interface web et un autre pour les API).

La m√©thode `guard` permet de sp√©cifier quel guard utiliser dans un contexte donn√©. Par d√©faut, le guard utilis√© est celui d√©fini dans la configuration (`web`), mais vous pouvez facilement sp√©cifier un autre guard en fonction de vos besoins (par exemple, pour les API avec JWT).

#### Exemple d'utilisation de `guard` :

```php
// Authentifier un utilisateur en utilisant le guard 'web' (session)
Auth::guard('web')->attempts([
    'email' => 'john@example.com',
    'password' => 'secret'
]);

// Authentifier un utilisateur en utilisant le guard 'api' (JWT)
Auth::guard('api')->attempts([
    'email' => 'john@example.com',
    'password' => 'secret'
]);
```

:::note
Ici, `Auth::guard('web')` sp√©cifie que nous voulons utiliser le guard `web`, qui est configur√© pour l'authentification par session. Vous pouvez √©galement remplacer `'web'` par `'api'` pour utiliser le guard configur√© pour JWT. Vous pouvez aussi utiliser le helper `app_auth`
:::

### M√©thode `attempts`

La m√©thode `attempts` est utilis√©e pour **authentifier un utilisateur** en v√©rifiant ses **identifiants**. Elle prend un tableau d'identifiants (souvent `email` et `password`) et retourne `true` si l'authentification est r√©ussie, ou `false` si elle √©choue.

- Elle est g√©n√©ralement utilis√©e lorsqu'un utilisateur soumet un formulaire de connexion.
- Elle peut √™tre appel√©e sur un **guard** sp√©cifique pour authentifier l'utilisateur en fonction de son contexte (par exemple, via JWT ou session).

#### Exemple d'utilisation de `attempts` :

```php
// Authentifier un utilisateur avec des identifiants
$credentials = [
    'email' => 'john@example.com',
    'password' => 'secret'
];

// Tentative d'authentification via le guard 'web'
if (Auth::guard('web')->attempts($credentials)) {
    echo 'Authentification r√©ussie via session';
} else {
    echo '√âchec de l\'authentification';
}
```

Dans cet exemple, la m√©thode `attempts` essaie d'authentifier l'utilisateur avec les identifiants fournis. Si les informations sont correctes, l'utilisateur est authentifi√©, et une session est cr√©√©e pour lui (dans le cas du guard `web`).

### M√©thode `check`

La m√©thode `check` permet de v√©rifier si l'utilisateur est actuellement authentifi√©. Elle retourne `true` si un utilisateur est connect√© (quel que soit le guard utilis√©), et `false` sinon.

#### Exemple d'utilisation de `check` :

```php
// V√©rifier si l'utilisateur est authentifi√© via le guard 'web'
if (Auth::guard('web')->check()) {
    echo 'L\'utilisateur est authentifi√©';
} else {
    echo 'Aucun utilisateur authentifi√©';
}
```

Cette m√©thode est tr√®s utile pour prot√©ger des routes ou ex√©cuter des actions en fonction de l'√©tat d'authentification de l'utilisateur.

### M√©thode `guest`

La m√©thode `guest` est l'oppos√©e de `check`. Elle retourne `true` si l'utilisateur **n'est pas authentifi√©** et `false` s'il est connect√©.

#### Exemple d'utilisation de `guest` :

```php
// V√©rifier si l'utilisateur n'est pas authentifi√© via le guard 'web'
if (Auth::guard('web')->guest()) {
    echo 'Aucun utilisateur authentifi√©';
} else {
    echo 'L\'utilisateur est authentifi√©';
}
```

### M√©thode `user`

La m√©thode `user` permet de r√©cup√©rer l'**utilisateur actuellement authentifi√©**. Elle retourne l'instance de votre mod√®le utilisateur (par exemple, `App\Models\User`) ou `null` si aucun utilisateur n'est connect√©.

#### Exemple d'utilisation de `user` :

```php
// R√©cup√©rer l'utilisateur connect√© via le guard 'web'
$user = Auth::guard('web')->user();

if ($user) {
    echo 'Utilisateur authentifi√© : ' . $user->name;
} else {
    echo 'Aucun utilisateur authentifi√©';
}
```

### M√©thode `id`

La m√©thode `id` permet de r√©cup√©rer l'**ID** de l'utilisateur actuellement authentifi√©. Cela peut √™tre utile si vous n'avez besoin que de l'ID de l'utilisateur sans avoir √† r√©cup√©rer l'objet complet.

#### Exemple d'utilisation de `id` :

```php
// R√©cup√©rer l'ID de l'utilisateur connect√© via le guard 'web'
$userId = Auth::guard('web')->id();

if ($userId) {
    echo 'L\'ID de l\'utilisateur authentifi√© est ' . $userId;
} else {
    echo 'Aucun utilisateur authentifi√©';
}
```

### M√©thode `login`

La m√©thode `login` est utilis√©e pour **connecter un utilisateur explicitement**. Vous pouvez l'utiliser avec un mod√®le utilisateur que vous avez r√©cup√©r√© de la base de donn√©es, par exemple apr√®s une tentative de connexion r√©ussie.

#### Exemple d'utilisation de `login` :

```php
$user = User::find(1); // Trouver un utilisateur
Auth::guard('web')->login($user); // Connecter l'utilisateur via le guard 'web'
```

### M√©thode `logout`

La m√©thode `logout` permet de **d√©connecter l'utilisateur actuellement authentifi√©**. Elle d√©truit la session de l'utilisateur (dans le cas du guard `web`) ou r√©voque son token JWT (dans le cas du guard `api`).

#### Exemple d'utilisation de `logout` :

```php
// D√©connecter l'utilisateur via le guard 'web'
Auth::guard('web')->logout();
```

## 4. Authentification avec JWT

Si vous souhaitez utiliser des tokens JWT pour l'authentification (tr√®s couramment utilis√© dans les API), vous devez installer le package `bowphp/policier` :

```bash
composer require bowphp/policier
```

### Configuration de JWT

Vous devez configurer JWT dans le fichier `config/policier.php` pour d√©finir les param√®tres li√©s √† la s√©curit√© des tokens.

```php
return [
    "signkey" => app_env("APP_JWT_SECRET"), // Cl√© secr√®te
    "exp" => 3600 * 24 * 3, // Expiration en secondes (ici 3 jours)
    "iss" => app_env("APP_JWT_ISSUER", "app.example.com"), // √âmetteur du token
    "alg" => "HS512", // Algorithme de signature
    "aud" => app_env("APP_JWT_AUD", "app.example.com"), // Audience
];
```

### Utilisation de JWT

Une fois configur√©, vous pouvez utiliser JWT pour authentifier un utilisateur via l'API.

```php
// Authentifier l'utilisateur via le guard 'api' (JWT)
Auth::guard('api')->attempts($credentials);

// V√©rifier si l'utilisateur est authentifi√© via le JWT
if (Auth::guard('api')->check()) {
    // Utilisateur authentifi√© via JWT
}

// R√©cup√©rer le token g√©n√©r√©
$token = Auth::guard('api')->getToken();
```

## Middleware d'authentification

Les middlewares permettent de prot√©ger certaines routes de votre application, en assurant que seules les personnes authentifi√©es peuvent y acc√©der. BowPHP inclut un middleware d'authentification pr√™t √† l'emploi.

### Exemple d'utilisation :

```php
$app->get('/profile', function () {
    // Route prot√©g√©e, accessible uniquement aux utilisateurs authentifi√©s
})->middleware('auth');
```

Et aussi, vous utilisez JWT, vous devez utiliser le middleware `api`. Regarde la configuration [policier](./policier).

```php
$app->get('/profile', function () {
    // Route prot√©g√©e, accessible uniquement aux utilisateurs authentifi√©s
})->middleware('api');
```

### Personnalisation du middleware

Si vous souhaitez personnaliser le comportement du middleware (par exemple, pour rediriger l'utilisateur vers une page sp√©cifique lorsqu'il n'est pas authentifi√©), vous pouvez √©tendre la classe `AuthMiddleware` :

```php
use Bow\Middlewares\AuthMiddleware;

class CustomAuthMiddleware extends AuthMiddleware
{
    // Redirection personnalis√©e en cas de non-authentification
    public function redirectTo(): string
    {
        return '/login'; // Rediriger vers une page de connexion
    }
}
```

<SuggestionFeature />
