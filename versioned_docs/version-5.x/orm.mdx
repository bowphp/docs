---
id: orm
title: "üß© ORM Barry"
---

import SuggestionFeature from "@site/src/components/Partials/SuggestionFeature";

<h1 align="center">
  <img src="https://raw.githubusercontent.com/bowphp/arts/master/barry.jpg" width="150px" alt="barry"/>
  <br/><span>Barry ORM</span>
</h1>

<p align="center">Barry c'est l'ORM (<strong>Object Relation Mapping</strong>) int√©gr√© dans Bow Framework.</p>

## Introduction

:::info
Un ORM (Object Relation Mapping) est une fa√ßon de relier les tables entre elles en utilisant des classes. Chaque enregistrement d'une table repr√©sente un objet qui peut √™tre en relation avec d'autres enregistrements.
:::

L'ORM inclus avec Bow Framework fournit une impl√©mentation ActiveRecord simple et √©l√©gante pour travailler avec votre base de donn√©es. Chaque table de base de donn√©es a un "mod√®le" correspondant qui est utilis√© pour interagir avec cette table. Les mod√®les vous permettent de rechercher des donn√©es dans vos tables, ainsi que d'ins√©rer de nouveaux enregistrements.

Dans tout bon framework qui se respecte, il y a un syst√®me ORM avec un nom sympathique. Celui de Bow se nomme **Barry**.

:::warning Pr√©requis
Avant de commencer, assurez-vous de configurer une connexion √† la base de donn√©es dans `config/database.php`.
:::

Avant de continuer, veuillez ajouter une migration :

```bash
php bow add:migration CreateTodoTable
```

Ensuite modifiez la migration:

```php
public function up()
{
  $this->create("todos", function (SQLGenerator $table) {
    $table->addIncrement('id');
    $table->addString('title');
    $table->addInteger('status', ["default" => 1]);
    $table->addInteger('budget', ["default" => 0]);
    $table->addTimestamps();
  });
}
```

Enfin, faites la migration :

```bash
php bow migration:migrate
```

:::tip Information
Cette migration sera utilis√©e pour vous permettre de faire directement les tests sur le mod√®le `App\Models\Todo::class`.
:::

## Ajouter un mod√®le

Pour ajouter un mod√®le, il faut utiliser la ligne de commande `php bow` avec la commande `add:model` suivi du nom du mod√®le.

```bash
php bow add:model Todo
```

Apr√®s cr√©ation du mod√®le, un fichier du m√™me nom sera cr√©√©, dans notre cas `Todo.php`, √† la racine du dossier `app/Models`.

Voici un aper√ßu du fichier :

```php
namespace App\Models;

use Bow\Database\Barry\Model;

class Todo extends Model
{
  //
}
```

:::warning Important
Avant d'utiliser le mod√®le, v√©rifiez que vous avez configur√© votre base de donn√©es.
:::

### Nom de table

Notez que nous n'avons pas indiqu√© √† Barry quelle table utiliser pour notre mod√®le `Todo`. Par convention, en "snake_case", le nom pluriel de la classe sera utilis√© comme nom de table √† moins qu'un autre nom ne soit explicitement sp√©cifi√©.

Vous pouvez sp√©cifier manuellement un nom de table en d√©finissant une propri√©t√© `table` sur votre mod√®le :

```php
namespace App\Models;

use Bow\Database\Barry\Model;

class Todo extends Model
{
  /**
   * D√©finissez la table associ√©e au mod√®le.
   *
   * @var string
   */
  protected $table = 'todos';
}
```

### Cl√©s primaires

Barry supposera √©galement que chaque table a une colonne de cl√© primaire nomm√©e `id`. Vous pouvez d√©finir une propri√©t√© `$primary_key` prot√©g√©e pour remplacer cette convention :

```php
namespace App\Models;

use Bow\Database\Barry\Model;

class Todo extends Model
{
  /**
   * La cl√© primaire associ√©e √† la table.
   *
   * @var string
   */
  protected $primary_key = 'id_todo';
}
```

## R√©cup√©rer les donn√©es

:::info
Une fois que vous avez cr√©√© un mod√®le et sa table de base de donn√©es associ√©e, vous √™tes pr√™t √† commencer √† r√©cup√©rer les donn√©es. Consid√©rez chaque mod√®le Barry comme un puissant [g√©n√©rateur de requ√™tes](./query-builder) vous permettant d'interroger la table de base de donn√©es associ√©e au mod√®le.
:::

Par exemple:

```php
use App\Models\Todo;

$todos = Todo::all();

foreach ($todos as $todo) {
  echo $todo->title;
}
```

La m√©thode `find` et `findBy` permet aussi de r√©cup√©rer les informations:

```php
// Avec find
$todo = Todo::find(1);

// Avec findBy
$todo = Todo::findBy('id', 1);
```

:::tip Remarque
La m√©thode peut aussi retourner `null` dans le cas o√π il n'y a aucun enregistrement trouv√©.
:::

## Ajout de contraintes suppl√©mentaires

La m√©thode Barry `all` retournera tous les r√©sultats dans le tableau du mod√®le. √âtant donn√© que chaque mod√®le Barry sert de [g√©n√©rateur de requ√™tes](./query-builder), vous pouvez √©galement ajouter des contraintes aux requ√™tes, puis utiliser la m√©thode `get` pour r√©cup√©rer les r√©sultats :

```php
$flights = App\Models\Todo::where('status', 'done')
            ->orderBy('title', 'desc')
            ->take(10)
            ->get();
```

## R√©cup√©ration d'agr√©gats

Vous pouvez √©galement utiliser les m√©thodes `count`, `sum`, `max` et d'autres m√©thodes d'agr√©gation fournies par le [g√©n√©rateur de requ√™tes](./query-builder). Ces m√©thodes renvoient la valeur scalaire appropri√©e au lieu d'une instance de mod√®le compl√®te:

```php
use App\Models\Todo;

$count = Todo::where('status', 'done')->count();

$max = Todo::where('status', 'done')->max('budget');
```

## Insertion et mise √† jour de mod√®les

### INSERT

Pour cr√©er un nouvel enregistrement dans la base de donn√©es, cr√©ez une nouvelle instance de mod√®le, d√©finissez des attributs sur le mod√®le, puis appelez la m√©thode de sauvegarde:

```php

namespace App\Http\Controllers;

use App\Controllers\Controller;
use App\Models\Todo;
use Bow\Http\Request;

class TodoController extends Controller
{
  /**
   * Cr√©ez une nouvelle instance de todo.
   *
   * @param Request $request
   * @return mixed
   */
  public function store(Request $request)
  {
    // Validez la demande...

    $todo = new Todo;

    $todo->title = $request->get('title');
    $todo->budget = $request->get('budget', 0);
    $todo->status = 'pending';

    $todo->save();
  }
}
```

Dans cet exemple, nous affectons le param√®tre de nom de la requ√™te HTTP entrante √† les attributs `title`, `budget` de l'instance de mod√®le `App\Models\Todo`. Lorsque nous appelons la m√©thode `save`, un enregistrement sera ins√©r√© dans la base de donn√©es. Les horodatages `created_at` et `updated_at` seront automatiquement d√©finis lorsque la m√©thode de sauvegarde sera appel√©e, il n'est donc pas n√©cessaire de les d√©finir manuellement.

### Insert via CREATE

Les objets Active Record peuvent √™tre cr√©√©s √† partir d'un hachage, d'un bloc ou avoir leurs attributs d√©finis manuellement apr√®s la cr√©ation. La nouvelle m√©thode renverra un nouvel objet tandis que `create` renverra l'objet et l'enregistrera dans la base de donn√©es.

Par exemple, √©tant donn√© un utilisateur mod√®le avec des attributs de nom et d'occupation, l'appel de la m√©thode create cr√©era et enregistrera un nouvel enregistrement dans la base de donn√©es:

```php
use App\Models\Todo;

$user = Todo::create([
  'title' => 'Acheter un ticket metro',
  'budget' => 2000,
  'status' => 'pending',
]);
```

### UPDATE

La m√©thode `save` peut √©galement √™tre utilis√©e pour mettre √† jour des mod√®les qui existent d√©j√† dans la base de donn√©es. Pour mettre √† jour un mod√®le, vous devez le r√©cup√©rer, d√©finir les attributs que vous souhaitez mettre √† jour, puis appeler la m√©thode `save`. Encore une fois, l'horodatage `updated_at` sera automatiquement mis √† jour, il n'est donc pas n√©cessaire de d√©finir manuellement sa valeur:

```php
use App\Models\Todo;

$todo = Todo::find(1);

$todo->title = 'Shopping pour Franck';

$todo->save();
```

Vous pouvez aussi utiliser la m√©thode `update`. Cependant, vous devez d√©finir les conditions pour limiter l'impact de la mise √† jour.

```php
use App\Models\Todo;

Todo::where('status', 'done')
  ->update(['title' => 'Achat de ticket d\'avion']);
```

La m√©thode `update` attend un tableau de paires de colonnes et de valeurs repr√©sentant les colonnes √† mettre √† jour.

## Suppression de donn√©es

De m√™me, une fois r√©cup√©r√©, un objet Active Record peut √™tre d√©truit, ce qui le supprime de la base de donn√©es.

```php
use App\Models\Todo;

$todo = Todo::find(1);
$todo->delete();
```

Si vous souhaitez supprimer plusieurs enregistrements en masse, vous pouvez utiliser la m√©thode `destroyBy` ou `truncate`:

```php
// Delete all todo by id
Todo::deleteBy('id', 'David');

// delete all todo
Todo::truncate();
```

<SuggestionFeature />
