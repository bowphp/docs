---
id: migration
title: "ðŸ“‘ Migration"
---

import SuggestionFeature from "@site/src/components/Partials/SuggestionFeature";

- [Introduction](#introduction)
- [Ajouter une migration](#ajouter-une-migration)
- [Structure de migration](#structure-de-migration)
- [ExÃ©cuter des migrations](#exÃ©cuter-des-migrations)
- [Faire reculer les migrations](#faire-reculer-les-migrations)
- [CrÃ©ation de table](#crÃ©ation-de-table)
- [Connexion Ã  la base de donnÃ©es et options de table](#connexion-Ã -la-base-de-donnÃ©es-et-options-de-table)
- [Renommer / Supprimer des tables](#renommer--supprimer-des-tables)
- [CrÃ©er des colonnes](#crÃ©er-des-colonnes)
- [Api de migration](#api-de-migration)
  - [Examinons ensemble](#examinons-ensemble)
  - [Liste des helpers](#liste-des-helpers)

## Introduction

Les migrations sont un moyen pour versionner votre base de donnÃ©e qui Ã©volue souvent avec les modifications de l'application.

Les migrations sont sauvegardÃ©s dans le dossier `migration`.

## Ajouter une migration

Pour ajouter une migration il faut passer par `php bow` avec la commande `add:migration` ensuite le nom de la migration(ex: `createTodosTable`). Bow crÃ©ra un fichier du mÃªme nom prÃ©cÃ©dÃ© d'une date de crÃ©ation.

```bash
php bow add:migration create_todos_table
```

Les options `--table` et `--create` peuvent Ã©galement Ãªtre utilisÃ©es pour indiquer le nom de la table et indiquer si la migration crÃ©era une nouvelle table. Ces options prÃ©-remplissent le fichier de raccord de migration gÃ©nÃ©rÃ© avec la table spÃ©cifiÃ©e:

Si vous voulez ajouter directement le nom de table dans la migration, ajouter le flag `--create=nom_de_la_table` ou `--table=nom_de_la_table`.

```bash
php bow add:migration create_todos_table --create=todos

php bow add:migration create_todos_table --table=todos
```

## Structure de migration

Une classe de migration contient deux mÃ©thodes: `up` et `rollback`. La mÃ©thode `up` sert Ã  ajouter de nouvelles tables, colonnes ou index Ã  votre base de donnÃ©es, tandis que la mÃ©thode `rollback` doit inverser les opÃ©rations effectuÃ©es par la mÃ©thode `up`.

Par exemple, la migration crÃ©Ã© prÃ©cÃ©dement:

```php
use Bow\Database\Migration\Migration;
use Bow\Database\Migration\SQLGenerator;

class Version20190929153939CreatTodosTable extends Migration
{
  /**
   * Create Table
   */
  public function up()
  {
    $this->create("users", function (SQLGenerator $table) {
      $table->addIncrement('id');
      $table->addTimestamps();
    });
  }

  /**
   * Drop Table
   */
  public function rollback()
  {
    $this->dropIfExists("users");
  }
}
```

## ExÃ©cuter des migrations

Pour exÃ©cuter toutes vos migrations en attente, exÃ©cutez la commande `migration:migrate` de la commande Bow:

```bash
php bow migration:migrate
```

Vous pouvez aussi utiliser le racourci `migrate`.

```bash
php bow migrate
```

## Faire reculer les migrations

Pour annuler la derniÃ¨re opÃ©ration de migration, vous pouvez utiliser la commande d'annulation. Cette commande annule le dernier "lot" de migrations, qui peut inclure plusieurs fichiers de migration:

```bash
php artisan migration:rollback
```

La commande `migration:reset` annule toutes les migrations de votre application:

```bash
php artisan migration:reset
```

## CrÃ©ation de table

Pour crÃ©er une nouvelle table de base de donnÃ©es, utilisez la mÃ©thode `create`. La mÃ©thode `create` accepte deux arguments. Le premier est le nom de la table, tandis que le second est une clÃ´ture qui reÃ§oit un objet `\Bow\Database\Migration\SQLGenerator::class` pouvant Ãªtre utilisÃ© pour dÃ©finir la nouvelle table:

```php
$this->create("users", function (SQLGenerator $table) {
  $table->addIncrement('id');
  $table->addTimestamps();
});
```

## Connexion Ã  la base de donnÃ©es et options de table

Si vous souhaitez effectuer une opÃ©ration de schÃ©ma sur une connexion Ã  une base de donnÃ©es autre que la connexion par dÃ©faut, utilisez la mÃ©thode de `connection` suivante:

```php
$this->connection('name')->create("users", function (SQLGenerator $table) {
  $table->addIncrement('id');
  $table->addTimestamps();
});
```

Vous pouvez utiliser les commandes suivantes dans le gÃ©nÃ©rateur de schÃ©ma pour dÃ©finir les options de la table:

| ParamÃ¨tre | Description |
|----------|------|
| **$table->withEngine('InnoDB')** | Ici, on modifie le systÃ¨me de storage |
| **$table->withCharset('utf8')** | Ici, on modifie l'encodage |
| **$table->withCollation('utf8_unicode_ci')** | Ici, SpÃ©cifier un classement par dÃ©faut pour la table |

## Renommer / Supprimer des tables

Pour renommer une table de base de donnÃ©es existante, utilisez la mÃ©thode `renameTable`:

```php
public function up()
{
  $this->renameTable($from, $to);
}
```

Pour supprimer une table existante, vous pouvez utiliser les mÃ©thodes drop ou `dropIfExists`:

```php
public function rollback()
{
  $this->drop('users');
  
  $this->dropIfExists('users');
}
```

> Avant de renommer une table, vous devez vÃ©rifier que toutes les contraintes de clÃ© Ã©trangÃ¨re sur la table ont un nom explicite dans vos fichiers de migration au lieu de laisser BowPHP attribuer un nom basÃ© sur une convention. Sinon, le nom de la contrainte de clÃ© Ã©trangÃ¨re fera rÃ©fÃ©rence Ã  l'ancien nom de la table.

## CrÃ©er des colonnes

La mÃ©thode de `alter` sur `Bow\Database\Migration\Migration::class` peut Ãªtre utilisÃ©e pour mettre Ã  jour des tables existantes. Comme la mÃ©thode `create`, la mÃ©thode `alter` accepte deux arguments: le nom de la table et une clÃ´ture qui reÃ§oit une instance de `\Bow\Database\Migration\SQLGenerator::class` que vous pouvez utiliser pour ajouter des colonnes Ã  la table:

```php
use Bow\Database\Migration\SQLGenerator;

public function up()
{
  $this->alter('users', function (SQLGenerator $table) {
    $table->addString('name');
  });
}
```

## Api de migration

Notons pour l'instant que tous ces mÃ©thodes sont en rÃ©alitÃ© des helpers de la mÃ©thode `addColumn` de `\Bow\Database\Migration\SQLGenerator::class`.

### Examinons ensemble

Prototype de la mÃ©thode `addColumn`.

```php
$table->addColumn(string $column_name, string $column_type, array $column_attributes);
```

| ParamÃ¨tre | Type | Description |
|----------|------|------|
| $column_name  | **String** | Le nom de la colonne de la table |
| $column_type  | **String** | Le type de la colonne de la table |
| $column_attributes   | **Array** | Les diffÃ©rents attributes de la colonne en fonction du type |

Liste des attributes: **unique**, **primary**, **index**, **increment**, **default**, **size**, **nullable**, **unsigned**.

| ParamÃ¨tre | Type | Description |
|----------|------|------|
| unique  | **Boolean** | Ajout UNIQUE sur la description de la colonne |
| primary  | **Boolean** | Define la colonne comme une clÃ© primaire. Ajout PRIMARY AUTO sur la description de la colonne |
| index  | **Boolean** | Definie la colonne comme une INDEX |
| increment  | **Boolean** | Definie la colonne comme une AUTO INCREMENT |
| size  | **Integer** | Definie la taille de la colonne |
| nullable  | **Boolean** | La colonne pourra avoir une valeur nul |
| unsigned  | **Boolean** | Seulement pour les colonnes de type nombre. Elle define la colonne comme non signÃ© |
| default  | **Mixed** | Ajout une valeur par defaut Ã  la colonne si une valeur n'est pas ajoutÃ© |

Regardons ensemble cette exemple:

```php
$table->addColumn('id', 'int', [
  'primary' => true,
  'increment' => true,
  'size' => 11
]);

$table->addColumn('price', 'int', [
  'size' => 11,
  'unsigned' => true
]);

$table->addColumn('name', 'string', [
  'nullable' => true,
  'default' => 'Franck DAKIA',
  'size' => 200
]);
```

### Liste des helpers

Bien entendu, le gÃ©nÃ©rateur de schÃ©ma contient divers types de colonnes que vous pouvez spÃ©cifier lors de la construction de vos tables:

| Commande | Description |
|----------|------|
| $table->addIncrement('id') | IncrÃ©mentation automatique de la colonne Ã©quivalente Ã  INTEGER (clÃ© primaire). |
| $table->addBigIncrement('id') | IncrÃ©mentation automatique de la colonne Ã©quivalente Ã  BIGINT (clÃ© primaire). |
| $table->addMediumIncrement('id') | IncrÃ©mentation automatique de la colonne Ã©quivalente Ã  MEDIUMINT (clÃ© primaire). |
| $table->addString('name', $attr = []) | Colonne Ã©quivalente Ã  VARCGAR. |
| $table->addInteger('price', $attr = []) | Colonne Ã©quivalente Ã  INTEGER. |
| $table->addBigInteger('price', $attr = []) | Colonne Ã©quivalente Ã  BIGINT. |
| $table->addDouble('price', $attr = []) | Colonne Ã©quivalente Ã  DOUBLE. |
| $table->addTinyInteger('status', $attr = []) | Colonne Ã©quivalente Ã  TINYINT |
| $table->addMediumInteger('status', $attr = []) | Colonne Ã©quivalente Ã  MEDIUMINT |
| $table->addBoolean('column') | Colonne Ã©quivalente Ã  BOOLEAN |
| $table->addFloat('column') | Colonne Ã©quivalente Ã  FLOAT |
| $table->addFloatPrimary('column') | Colonne Ã©quivalente Ã  FLOAT (clÃ© primaire) |
| $table->addDouble('column') | Colonne Ã©quivalente Ã  DOUBLE |
| $table->addDoublePrimary('column') | Colonne Ã©quivalente Ã  DOUBLE (clÃ© primaire) |
| $table->addUuid('uuid') | Colonne Ã©quivalente Ã  UUID |
| $table->addBinary('uuid') | Colonne Ã©quivalente Ã  BINARY |
| $table->addIpAddress('uuid') | Colonne Ã©quivalente Ã  IP |
| $table->addMacAddress('uuid') | Colonne Ã©quivalente Ã  MAC |
| $table->addDatetime('date_column') | Colonne Ã©quivalente Ã  DATETIME |
| $table->addDate('date_column') | Colonne Ã©quivalente Ã  DATE |
| $table->addTime('date_column') | Colonne Ã©quivalente Ã  TIME |
| $table->addYear('date_column') | Colonne Ã©quivalente Ã  YEAR |
| $table->addTimestamp('date_column') | Colonne Ã©quivalente Ã  TIMESTAMP |
| $table->addTimestamps() | Ajout les colonnes `updated_at` et `created_at` en TIMESTAMP |

<SuggestionFeature />
