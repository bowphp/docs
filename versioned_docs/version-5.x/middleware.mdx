---
id: middleware
title: "ğŸš¥ Middlewares"
---

import SuggestionFeature from "@site/src/components/Partials/SuggestionFeature";

## Introduction

:::info Ã€ propos des middlewares
Les middlewares constituent un mÃ©canisme pratique pour filtrer les requÃªtes HTTP entrant dans votre application.
:::

Par exemple, vous pouvez faire un middleware pour vÃ©rifier si un utilisateur est connectÃ© et ensuite faire une action en fonction. Vous pouvez exÃ©cuter du code avant et aprÃ¨s votre application Bow pour manipuler les objets `Request` et `Response` comme bon vous semble.

[![asciicast](https://asciinema.org/a/bfTIiqg1ew9x1QRxeMTufxJJU.svg)](https://asciinema.org/a/bfTIiqg1ew9x1QRxeMTufxJJU)

## Comment Ã§a marche

DiffÃ©rents frameworks utilisent le systÃ¨me de middlewares diffÃ©remment. Bow ajoute un middleware sous forme de file d'attente au-dessus de votre application principale. Chaque nouvelle couche de middleware est ajoutÃ©e Ã  la file de middlewares existante. La structure de file se dilate vers l'extÃ©rieur au fur et Ã  mesure que les couches intermÃ©diaires supplÃ©mentaires sont ajoutÃ©es.

Lorsque vous exÃ©cutez l'application Bow, les objets Request traversent la structure du middleware de l'extÃ©rieur vers l'intÃ©rieur. Ils entrent d'abord dans le middleware le plus externe, puis dans le prochain middleware le plus externe (et ainsi de suite), jusqu'Ã  ce qu'ils atteignent l'application elle-mÃªme. Une fois que l'application Bow a distribuÃ© la route appropriÃ©e, l'objet Response rÃ©sultant quitte l'application Bow et est sÃ©rialisÃ© dans une rÃ©ponse HTTP qui est renvoyÃ©e au client HTTP.

La seule condition stricte est qu'un middleware doit renvoyer une valeur autre que `null`. Chaque middleware devra appeler le middleware suivant et lui transmettre les objets `Request` comme arguments via la mÃ©thode `$next`.

:::tip Middlewares par dÃ©faut
Bow inclut plusieurs middlewares par dÃ©faut comme le middleware `csrf` et `auth`.
:::

## Ajouter un middleware

Pour ajouter un middleware il faut utiliser la commande `add:middleware` de `php bow`:

```bash
php bow add:middleware IpMiddleware
```

:::info Emplacement des middlewares
Tous les middlewares sont sauvegardÃ©s par dÃ©faut dans le dossier `app/Middlewares`.
:::

Le middleware que nous venons d'ajouter vÃ©rifiera l'adresse IP du client et si son adresse est Ã©gale Ã  `127.0.0.1`, on dira que l'application est en mode dÃ©veloppement.

Mais d'abord, regardons le contenu du fichier `IpMiddleware`. C'est la mÃ©thode `process` qui permet de lancer le middleware et le callable permet de lancer le prochain middleware.

```php title="app/Middlewares/IpMiddleware.php"
namespace App\Middlewares;

use Bow\Http\Request;

class IpMiddleware
{
  /**
   * Fonction de lancement du middleware.
   *
   * @param Request $request
   * @param callable $next
   */
  public function process(Request $request, callable $next)
  {
    //
    return $next($request);
  }
}
```

Pour notre exemple on aura alors le `process` suivant:

```php
public function process(Request $request, callable $next)
{
  if ($request->ip() == '127.0.0.1') {
    return "MODE DEV";
  }

  return $next($request);
}
```

## Enregistrement de middleware

GÃ©nÃ©ralement, l'enregistrement se fait dans le fichier `app/Kernel.php` avec une clÃ© qui l'identifie.

```php
public function middlewares()
{
  return [
    ...
    'ip' => \App\Middlewares\IpMiddleware::class
    ...
  ];
}
```

Il est aussi possible d'ajouter les middlewares de faÃ§on globale dans l'application. Ceci se fait dans le fichier de `routes` avec la mÃ©thode `middleware` sur `$app` qui va nous retourner une instance de `\Bow\Router\Router::class`. Toutes les routes qui seront dÃ©finies avec cette instance hÃ©riteront des middlewares spÃ©cifiÃ©s.

```php
$router = $app->middleware(\App\Middlewares\IpMiddleware::class);
$router->get('/', 'HomeController::index');

// Ou
$router = $app->middleware([
  \App\Middlewares\IpMiddleware::class,
  \App\Middlewares\OtherMiddleware::class,
]);
$router->get('/', 'HomeController::index');
```

## Utilisation des middlewares

:::tip Application des middlewares
AprÃ¨s avoir dÃ©fini un middleware dans le fichier `app/Kernel.php`, vous pouvez l'appliquer Ã  vos routes.
:::

```php
$app->get('/', 'HomeController::index')->middleware('ip');
$app->get('/', 'HomeController::index')->middleware(['ip', 'autre']);

// ou
$app->route([
  'path' => '/',
  'method' => 'GET',
  'handler' => 'HomeController::index',
  'middleware' => ['ip', 'autre']
]);
```

<SuggestionFeature />
